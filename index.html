<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>Portfolio Constructor</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#F8FAFC;--card:#FFFFFF;--border:#E2E8F0;--text:#0F172A;--sub:#64748B;--sub2:#94A3B8;--green:#10B981;--red:#EF4444;--font:'Inter',system-ui,sans-serif;--r:16px}
html{-webkit-tap-highlight-color:transparent}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;font-size:15px}
input[type=number]{-moz-appearance:textfield}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
#topbar{background:rgba(255,255,255,.85);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-bottom:1px solid var(--border);padding:14px 20px 10px;position:sticky;top:0;z-index:200}
.tb-row1{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.tb-title{font-size:1.2rem;font-weight:800;letter-spacing:-.02em;line-height:1.2}
.tb-sub{font-size:.72rem;color:var(--sub);margin-top:1px}
.tb-name-row{display:flex;align-items:center;gap:6px}
.tb-name-lbl{font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;font-weight:700;color:var(--sub2);white-space:nowrap}
#pname{flex:0 1 180px;max-width:180px;background:#F8FAFC;border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:.82rem;font-family:var(--font);color:var(--text);outline:none;transition:box-shadow .2s,border-color .2s}
#pname:focus{border-color:#94A3B8;box-shadow:0 0 0 3px rgba(148,163,184,.15)}
#pname::placeholder{color:var(--sub2)}
#btnReset{display:flex;align-items:center;gap:5px;flex-shrink:0;background:#FFF1F2;border:1px solid #FECDD3;color:#E11D48;border-radius:8px;padding:6px 12px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);transition:background .18s,transform .15s;white-space:nowrap}
#btnReset:hover{background:#FFE4E6;transform:scale(1.03)}
#btnReset:active{transform:scale(.96)}
#prog-wrap{background:rgba(255,255,255,.85);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);padding:0;border-bottom:1px solid var(--border);position:sticky;top:96px;z-index:190}
#prog-inner{padding:0 20px 10px}
.prog-row{display:flex;justify-content:space-between;align-items:flex-end;padding:8px 0 6px}
.prog-lbl-txt{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--sub2)}
#progPct{font-size:1.35rem;font-weight:900;letter-spacing:-.03em;color:var(--green);transition:color .3s;line-height:1}
#progPct.c-over{color:var(--red)}
.prog-track{background:#E2E8F0;border-radius:99px;height:7px;overflow:hidden}
#progBar{height:100%;border-radius:99px;background:var(--green);width:0%;transition:width .4s cubic-bezier(.4,0,.2,1),background .3s}
#progStatus{font-size:.72rem;color:var(--sub);margin-top:5px;min-height:14px}
#main{padding:14px 14px 0;max-width:480px;margin:0 auto}
.p-card{background:var(--card);border-radius:var(--r);border:1px solid var(--border);margin-bottom:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.04),0 1px 2px rgba(0,0,0,.03)}
.p-head{display:flex;align-items:center;justify-content:space-between;padding:16px 16px 14px;cursor:pointer;user-select:none;-webkit-user-select:none}
.p-head-left{display:flex;align-items:center;gap:10px}
.p-colorbar{width:7px;height:32px;border-radius:99px;flex-shrink:0}
.p-name{font-size:1rem;font-weight:700;letter-spacing:-.01em;line-height:1.2}
.p-tally-err{font-size:.67rem;color:var(--red);font-weight:600;margin-top:1px;display:none;line-height:1}
.p-tally-err.show{display:block}
.p-pill{border-radius:99px;padding:4px 12px;font-size:.82rem;font-weight:700;white-space:nowrap}
.p-inp-row{display:flex;align-items:center;gap:3px}
.p-inp{width:52px;background:transparent;border:none;font-size:1rem;font-weight:700;text-align:right;outline:none;font-family:var(--font);color:inherit;padding:0;cursor:text}
.p-pct-sym{font-size:.88rem;font-weight:600;opacity:.7}
.p-chev{font-size:.7rem;color:var(--sub2);margin-left:2px;transition:transform .22s;display:inline-block;line-height:1}
.p-chev.open{transform:rotate(180deg)}
.s-section{display:none;border-top:1px solid #F1F5F9}
.s-section.open{display:block}
.s-list-area{padding:4px 16px 14px}
.s-list-row{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid #F8FAFC}
.s-list-row:last-child{border-bottom:none}
.s-list-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.s-list-name{font-size:.82rem;color:var(--sub);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.s-list-right{display:flex;align-items:center;gap:3px;flex-shrink:0}
.s-list-inp{width:44px;border:none;background:transparent;font-size:.82rem;font-weight:600;text-align:right;outline:none;font-family:var(--font);color:var(--text);padding:0}
.s-list-pct{font-size:.75rem;color:var(--sub);font-weight:500}
.s-expand-btn{display:flex;align-items:center;background:none;border:none;cursor:pointer;padding:0;margin-left:4px}
.s-expand-dot{width:16px;height:16px;border-radius:50%;background:#F1F5F9;display:flex;align-items:center;justify-content:center}
.s-expand-dot svg{width:9px;height:9px;fill:none;stroke:#94A3B8;stroke-width:1.5;transition:transform .18s}
.s-expand-dot.open svg{transform:rotate(180deg)}
.s-inst-area{background:#F8FAFC;border-top:1px solid #F1F5F9;padding:8px 16px 10px 20px;display:none;flex-direction:column;gap:5px}
.s-inst-area.open{display:flex}
.s-inst-row{display:flex;align-items:center;gap:8px}
.s-inst-lbl{font-size:.65rem;font-weight:700;color:var(--sub2);text-transform:uppercase;letter-spacing:.06em;min-width:44px}
.s-inst-sel{flex:1;border:1px solid var(--border);background:#fff;color:var(--text);border-radius:8px;padding:5px 8px;font-size:.74rem;outline:none;cursor:pointer;font-family:var(--font)}
.s-inst-sel:focus{border-color:#94A3B8}
.s-inst-foot{font-size:.65rem;color:var(--sub2);font-style:italic;padding-left:52px;margin-top:2px}
.s-custom-area{padding:6px 16px 14px;display:flex;flex-direction:column;gap:6px}
.s-custom-row{background:#F8FAFC;border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px}
.s-custom-icon{width:26px;height:26px;border-radius:50%;background:#E2E8F0;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:800;color:var(--sub);flex-shrink:0}
.s-custom-name{flex:1;font-size:.83rem;color:var(--sub);font-weight:500}
.s-custom-inp{width:44px;border:none;background:transparent;font-size:.83rem;font-weight:700;text-align:right;outline:none;font-family:var(--font);color:var(--text);padding:0}
.s-custom-pct{font-size:.76rem;color:var(--sub)}
.s-custom-note{padding:0 16px 12px}
.s-custom-note input{width:100%;border:1px solid var(--border);background:#fff;border-radius:8px;padding:6px 10px;font-size:.78rem;outline:none;font-family:var(--font);color:var(--text)}
.s-custom-note input:focus{border-color:#94A3B8}
#botbar-sentinel{height:1px;width:100%}
#botbar{background:rgba(255,255,255,.96);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);padding:10px 20px 20px;opacity:0;transform:translateY(20px);transition:opacity .3s ease,transform .3s ease;pointer-events:none}
#botbar.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.bot-inner{max-width:480px;margin:0 auto;display:flex;align-items:center;gap:12px}
.bot-alloc{flex:1}
.bot-alloc-lbl{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--sub2);margin-bottom:3px}
.bot-alloc-pct{font-size:1.45rem;font-weight:900;letter-spacing:-.03em;color:var(--green);line-height:1;transition:color .3s;margin-bottom:5px}
.bot-alloc-pct.c-over{color:var(--red)}
.bot-track{background:#E2E8F0;border-radius:99px;height:5px;overflow:hidden;width:100%}
.bot-bar{height:100%;border-radius:99px;background:var(--green);width:0%;transition:width .4s,background .3s}
.bot-bar.c-over{background:var(--red)}
.btn-summary{background:#0F172A;color:#fff;border:none;border-radius:11px;padding:0 18px;height:46px;font-size:.85rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;font-family:var(--font);transition:opacity .2s,transform .15s;white-space:nowrap}
.btn-summary.inactive{opacity:.35}
.btn-summary:not(.inactive):hover{opacity:.85;transform:translateY(-1px)}
.btn-pdf{background:var(--green);color:#fff;border:none;border-radius:11px;padding:0 14px;height:46px;font-size:.82rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;font-family:var(--font);transition:opacity .2s;white-space:nowrap}
.btn-pdf.inactive{opacity:.35}
.btn-pdf:not(.inactive):hover{opacity:.85}
.btn-pdf.loading{opacity:.7;cursor:wait}
#fab{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background:#fff;border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:290;transition:transform .2s,box-shadow .2s;font-size:1.3rem;color:var(--text);line-height:1}
#fab:hover{transform:scale(1.08);box-shadow:0 6px 18px rgba(0,0,0,.14)}
#fab:active{transform:scale(.94)}
#fab-tip{position:fixed;bottom:30px;right:74px;background:#1E293B;color:#fff;font-size:.68rem;font-weight:600;font-family:var(--font);padding:5px 10px;border-radius:7px;white-space:nowrap;pointer-events:none;opacity:0;transform:translateX(4px);transition:opacity .18s,transform .18s;z-index:291}
#fab-tip::after{content:'';position:absolute;top:50%;right:-5px;transform:translateY(-50%);border:5px solid transparent;border-left-color:#1E293B;border-right:none}
#fab:hover + #fab-tip{opacity:1;transform:translateX(0)}
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(8px);background:#1E293B;color:#fff;border-radius:10px;padding:10px 18px;font-size:.78rem;line-height:1.6;max-width:340px;width:calc(100% - 40px);box-shadow:0 8px 32px rgba(0,0,0,.2);pointer-events:none;opacity:0;transition:opacity .22s,transform .22s;z-index:400;white-space:pre-line;text-align:center}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
#resetOverlay{display:none;position:fixed;inset:0;background:rgba(15,23,42,.45);z-index:600;align-items:center;justify-content:center;padding:20px}
#resetOverlay.show{display:flex}
#resetDialog{background:#fff;border-radius:16px;padding:24px 20px 20px;width:100%;max-width:320px;box-shadow:0 20px 60px rgba(0,0,0,.18);text-align:center}
.rd-icon{font-size:2rem;margin-bottom:10px;line-height:1}
.rd-title{font-size:1rem;font-weight:800;color:var(--text);margin-bottom:6px}
.rd-sub{font-size:.78rem;color:var(--sub);line-height:1.5;margin-bottom:20px}
.rd-btns{display:flex;gap:10px}
.rd-cancel{flex:1;padding:10px;border-radius:9px;border:1px solid var(--border);background:#F8FAFC;color:var(--sub);font-size:.84rem;font-weight:700;cursor:pointer;font-family:var(--font);transition:background .15s}
.rd-cancel:hover{background:#F1F5F9}
.rd-confirm{flex:1;padding:10px;border-radius:9px;border:none;background:#E11D48;color:#fff;font-size:.84rem;font-weight:700;cursor:pointer;font-family:var(--font);transition:opacity .15s,transform .15s}
.rd-confirm:hover{opacity:.88;transform:translateY(-1px)}
#overlay{display:none;position:fixed;inset:0;background:rgba(15,23,42,.5);z-index:500;align-items:flex-end;justify-content:center}
#overlay.show{display:flex}
#modal{background:#fff;border-radius:20px 20px 0 0;width:100%;max-width:480px;max-height:88vh;overflow-y:auto;padding-bottom:env(safe-area-inset-bottom,20px)}
.m-handle{width:36px;height:4px;background:#E2E8F0;border-radius:99px;margin:10px auto 14px}
.m-hdr{padding:0 20px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #F1F5F9}
.m-title{font-size:1rem;font-weight:800;letter-spacing:-.01em}
.m-close{background:none;border:none;cursor:pointer;font-size:1.3rem;color:var(--sub);line-height:1;padding:2px 4px}
.m-body{padding:16px 20px}
.m-meta{font-size:.76rem;color:var(--sub);margin-bottom:14px}
.m-meta b{color:#0F172A;font-weight:700}
.m-pblock{margin-bottom:14px;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
.m-phdr{padding:9px 14px;display:flex;justify-content:space-between;font-weight:700;font-size:.85rem;color:#fff}
.m-subs{background:#F8FAFC}
.m-srow{padding:8px 14px 8px 18px;display:flex;justify-content:space-between;align-items:flex-start;border-bottom:1px solid #F1F5F9}
.m-srow:last-child{border-bottom:none}
.m-sname{font-size:.79rem;font-weight:700;color:#1E293B}
.m-sinst{font-size:.7rem;color:var(--sub);margin-top:2px}
.m-swt{font-size:.85rem;font-weight:800;color:#0F172A;padding-left:10px;white-space:nowrap}
.m-empty{padding:7px 18px;font-size:.74rem;color:#94A3B8;font-style:italic}
.m-total{margin-top:10px;padding:11px 14px;background:#ECFDF5;border-radius:10px;display:flex;justify-content:space-between;font-weight:800;font-size:.92rem;color:#065F46}
</style>
</head><body>
<div style="height:env(safe-area-inset-top,0px);background:#fff"></div>
<div id="topbar">
  <div class="tb-row1">
    <div><div class="tb-title">Portfolio Constructor</div><div class="tb-sub">Asset allocation</div></div>
    <button id="btnReset">&#x21BA; Reset</button>
  </div>
  <div class="tb-name-row">
    <label class="tb-name-lbl" for="pname">Name</label>
    <input id="pname" type="text" placeholder="e.g. Retirement 2045" autocomplete="off"/>
  </div>
</div>
<div id="prog-wrap"><div id="prog-inner">
  <div class="prog-row"><span class="prog-lbl-txt">Asset Allocation Progress</span><span id="progPct">0.0%</span></div>
  <div class="prog-track"><div id="progBar"></div></div>
  <div id="progStatus">Fill in the weight for each asset class to begin.</div>
</div></div>
<div id="main"><div id="builder"></div></div>
<div id="botbar-sentinel"></div>
<div id="botbar"><div class="bot-inner">
  <div class="bot-alloc">
    <div class="bot-alloc-lbl">Total Allocation</div>
    <div class="bot-alloc-pct" id="botPct">0.0%</div>
    <div class="bot-track"><div class="bot-bar" id="botBar"></div></div>
  </div>
  <button class="btn-summary inactive" id="btnSummary">&#x1F4CB; Summary</button>
  <button class="btn-pdf inactive" id="btnExport">&#x2B07; PDF</button>
</div></div>
<button id="fab" title="Expand all">+</button><div id="fab-tip">Expand all</div>
<div id="toast"></div>
<div id="resetOverlay">
  <div id="resetDialog">
    <div class="rd-icon">&#x26A0;&#xFE0F;</div>
    <div class="rd-title">Reset all weights?</div>
    <div class="rd-sub">This will clear all allocations, instrument selections, and the portfolio name. This cannot be undone.</div>
    <div class="rd-btns">
      <button class="rd-cancel" id="rdCancel">Cancel</button>
      <button class="rd-confirm" id="rdConfirm">Yes, reset</button>
    </div>
  </div>
</div>
<div id="overlay"><div id="modal">
  <div class="m-handle"></div>
  <div class="m-hdr"><span class="m-title">&#x1F4CB; Portfolio Summary</span><button class="m-close" id="btnClose">&times;</button></div>
  <div class="m-body" id="modalBody"></div>
</div></div>

<!-- CDN libs loaded lazily only when PDF is requested -->
<script>
var FUNDS={"sub_assets":{"flexicap":{"recommended":["Parag Parikh Flexi Cap Fund","HDFC Flexi Cap Fund"],"all":["Axis Flexi Cap Fund","Canara Robeco Flexi Cap Fund","DSP Flexi Cap Fund","Franklin India Flexi Cap Fund","Kotak Flexi Cap Fund","Mirae Asset Flexi Cap Fund","SBI Flexi Cap Fund","UTI Flexi Cap Fund"]},"focussed":{"recommended":["HDFC Focused Fund","ICICI Prudential Focused Equity Fund"],"all":["Axis Focused 25 Fund","DSP Focus Fund","Franklin India Focused Equity Fund","Mirae Asset Focused Fund","Nippon India Focused Equity Fund","SBI Focused Equity Fund","Sundaram Focused Fund"]},"midcap":{"recommended":["Invesco India Mid Cap Fund","HDFC Mid Cap Fund"],"all":["Axis Midcap Fund","Motilal Oswal Midcap Fund","Edelweiss Mid Cap Fund","Franklin India Prima Fund","Kotak Emerging Equity Fund","Mirae Asset Midcap Fund","Nippon India Growth Fund","PGIM India Midcap Opportunities Fund","SBI Magnum Midcap Fund"]},"smallcap":{"recommended":["Invesco India Smallcap Fund","Bandhan Small Cap Fund","Mirae Small Cap Fund"],"all":["Axis Small Cap Fund","Canara Robeco Small Cap Fund","DSP Small Cap Fund","HDFC Small Cap Fund","Kotak Small Cap Fund","SBI Small Cap Fund","Nippon India Small Cap Fund","Quant Small Cap Fund","Tata Small Cap Fund"]},"others_eq":{"recommended":["ICICI Prudential Dividend Yield Equity Fund","ICICI Prudential Thematic Advantage Fund (FOF)"],"all":["Aditya Birla Sun Life Dividend Yield Fund","SBI Dividend Yield Fund","UTI Dividend Yield Fund","HDFC Dividend Yield Fund","Templeton India Equity Income Fund"]},"us":{"recommended":["ICICI Prudential US Bluechip Equity","Motilal Oswal S&P 500 Index Fund"],"all":["DSP US Flexible Equity Fund","Franklin India Feeder Franklin US Opportunities Fund","Kotak US Equity Fund","Mirae Asset NYSE FANG+ ETF FoF","Nippon India US Equity Opportunities Fund"]},"china":{"recommended":["Mirae Asset Hang Seng TECH ETF FoF","Edelweiss Greater China Equity Off-shore Fund"],"all":["DSP Global Innovation Fund of Fund","PGIM India Global Equity Opportunities Fund","Nippon India Taiwan Equity Fund"]},"liquid":{"recommended":["ICICI Prudential Liquid Fund","HDFC Liquid Fund"],"all":["Aditya Birla Sun Life Liquid Fund","Axis Liquid Fund","Kotak Liquid Fund","Nippon India Liquid Fund","SBI Liquid Fund","UTI Liquid Cash Plan"]},"tmf":{"recommended":["HDFC Nifty SDL Plus G-Sec Jun 2027 40:60 Index Fund","ICICI Prudential Nifty G-Sec Jun 2027 Index Fund"],"all":["Axis CRISIL SDL 2027 Index Fund","Bandhan CRISIL-IBX Gilt Index June 2027 Fund","DSP Nifty SDL Plus G-Sec Jun 2028 30:70 Index Fund","Mirae Asset Nifty SDL Jun 2027 Index Fund","Nippon India Nifty SDL Plus G-Sec Jun 2028 Maturity 60:40 Index Fund"]},"arbitrage":{"recommended":["Tata Arbitrage Fund"],"all":["Aditya Birla Sun Life Arbitrage Fund","Axis Arbitrage Fund","HDFC Arbitrage Fund","ICICI Prudential Equity Arbitrage Fund","Kotak Equity Arbitrage Fund","Nippon India Arbitrage Fund","SBI Arbitrage Opportunities Fund"]},"gold_silver":{"recommended":["Motilal Oswal Gold and Silver ETFs FoF"],"all":[]},"gold":{"recommended":["Nippon India ETF Gold BeES"],"all":["ICICI Prudential Gold ETF","Zerodha Gold ETF"]},"silver":{"recommended":["Nippon India Silver ETF"],"all":["ICICI Prudential Silver ETF","Groww Silver ETF"]},"bitcoin":{"recommended":["CoinDCX Bitcoin"],"all":["WazirX Bitcoin","Coinbase Bitcoin"]}}};
var STRUCTURE=[
  {id:"equity",name:"Domestic Equity",custom:false,subs:[
    {id:"flexicap",name:"FlexiCap",fk:"flexicap",custom:false},
    {id:"focussed",name:"Focussed",fk:"focussed",custom:false},
    {id:"midcap",name:"MidCap",fk:"midcap",custom:false},
    {id:"smallcap",name:"SmallCap",fk:"smallcap",custom:false},
    {id:"others_eq",name:"Others",fk:"others_eq",custom:false},
    {id:"momentum",name:"Momentum (Stocks Portfolio)",fk:"momentum",custom:false},
    {id:"longterm",name:"Long-term (Stocks Portfolio)",fk:"longterm",custom:false}
  ]},
  {id:"intl",name:"International Equity",custom:false,subs:[
    {id:"us",name:"US",fk:"us",custom:false},
    {id:"china",name:"China",fk:"china",custom:false}
  ]},
  {id:"debt",name:"Debt",custom:false,subs:[
    {id:"icici_bond",name:"ICICI Prudential All Seasons Bond Fund",fk:"icici_bond",custom:false},
    {id:"liquid",name:"Liquid Fund",fk:"liquid",custom:false},
    {id:"tmf",name:"Target Maturity Funds",fk:"tmf",custom:false},
    {id:"arbitrage",name:"Arbitrage Fund",fk:"arbitrage",custom:false},
    {id:"sweep",name:"Sweep-in Fixed Deposits",fk:"sweep",custom:false}
  ]},
  {id:"reits",name:"REITs",custom:false,subs:[
    {id:"embassy",name:"Embassy Office Parks REIT",fk:"embassy",custom:false},
    {id:"biret",name:"Brookfield India Real Estate Trust",fk:"biret",custom:false},
    {id:"mindspace",name:"Mindspace Business Parks REIT",fk:"mindspace",custom:false},
    {id:"krt",name:"Knowledge REIT",fk:"krt",custom:false},
    {id:"nxst",name:"Nexus Select Trust REIT Units",fk:"nxst",custom:false}
  ]},
  {id:"commodities",name:"Commodities",custom:false,subs:[
    {id:"gold_silver",name:"Gold & Silver ETF FoF",fk:"gold_silver",custom:false},
    {id:"gold",name:"Gold ETF",fk:"gold",custom:false},
    {id:"silver",name:"Silver ETF",fk:"silver",custom:false}
  ]},
  {id:"alternatives",name:"Alternatives",custom:false,subs:[
    {id:"bitcoin",name:"Bitcoin",fk:"bitcoin",custom:false},
    {id:"pe",name:"Private Equity",fk:"pe",custom:false}
  ]},
  {id:"others_c",name:"Others (Custom)",custom:true,subs:[
    {id:"cash",name:"Cash",fk:"cash",custom:true},
    {id:"custom2",name:"Other Investments",fk:"custom2",custom:true}
  ]}
];
var pW={},sW={},ins={},cTxt={},pOpen={},sOpen={},toastTimer=null,allExpanded=false;
var ACCENT=[
  {bar:'#3B82F6',pb:'#EFF6FF',pt:'#2563EB'},
  {bar:'#E27D60',pb:'#FFF7ED',pt:'#C2622E'},
  {bar:'#A855F7',pb:'#FAF5FF',pt:'#9333EA'},
  {bar:'#6366F1',pb:'#EEF2FF',pt:'#4F46E5'},
  {bar:'#F59E0B',pb:'#FFFBEB',pt:'#D97706'},
  {bar:'#10B981',pb:'#ECFDF5',pt:'#059669'},
  {bar:'#F43F5E',pb:'#FFF1F2',pt:'#E11D48'},
  {bar:'#14B8A6',pb:'#F0FDFA',pt:'#0D9488'}
];
function ac(pi){return ACCENT[pi%ACCENT.length];}
function r1(v){return Math.round(v*10)/10;}
function mkEl(t,c){var e=document.createElement(t);if(c)e.className=c;return e;}
function mkNum(c,ph){var e=document.createElement('input');e.type='number';e.className=c;e.setAttribute('min','0');e.setAttribute('max','100');e.setAttribute('step','0.1');e.placeholder=ph||'0';return e;}

/* ââ Botbar sentinel ââ */
(function(){
  var s=document.getElementById('botbar-sentinel'),b=document.getElementById('botbar');
  if(!s||!b)return;
  new IntersectionObserver(function(en){en.forEach(function(e){b.classList.toggle('visible',e.isIntersecting);});},{threshold:0}).observe(s);
})();

/* ââ Build UI ââ */
function buildUI(){
  var b=document.getElementById('builder');b.innerHTML='';
  for(var pi=0;pi<STRUCTURE.length;pi++){
    var p=STRUCTURE[pi],a=ac(pi);
    pOpen[p.id]=false;pW[p.id]=null;
    var card=mkEl('div','p-card');card.id='pcard_'+p.id;
    var head=mkEl('div','p-head');
    var hl=mkEl('div','p-head-left');
    var cb=mkEl('div','p-colorbar');cb.style.background=a.bar;
    var nw=mkEl('div','');
    var nm=mkEl('div','p-name');nm.textContent=p.name;
    var te=mkEl('div','p-tally-err');te.id='terr_'+p.id;te.textContent='\u26a0 sub-weights don\'t add up';
    nw.appendChild(nm);nw.appendChild(te);
    hl.appendChild(cb);hl.appendChild(nw);
    var hr=mkEl('div','');hr.style.cssText='display:flex;align-items:center;gap:6px';
    var pill=mkEl('div','p-pill');pill.style.background=a.pb;pill.style.color=a.pt;
    var pr=mkEl('div','p-inp-row');
    var pinp=mkNum('p-inp','0');pinp.id='pinp_'+p.id;pinp.style.color=a.pt;
    var psym=mkEl('span','p-pct-sym');psym.textContent='%';psym.style.color=a.pt;
    pr.appendChild(pinp);pr.appendChild(psym);pill.appendChild(pr);
    var ch=mkEl('span','p-chev');ch.id='pchev_'+p.id;ch.textContent='\u25be';
    hr.appendChild(pill);hr.appendChild(ch);
    head.appendChild(hl);head.appendChild(hr);
    attachParentHead(p.id,pinp,head);
    card.appendChild(head);
    var sec=mkEl('div','s-section');sec.id='sec_'+p.id;
    for(var si=0;si<p.subs.length;si++){
      var s=p.subs[si];sW[s.id]=null;
      if(s.custom)sec.appendChild(buildCustomRow(s));
      else{sOpen[s.id]=false;sec.appendChild(buildSubRow(s));}
    }
    card.appendChild(sec);b.appendChild(card);
  }
}
function attachParentHead(pid,pinp,head){
  pinp.addEventListener('click',function(e){e.stopPropagation();});
  pinp.addEventListener('input',function(){var v=parseFloat(this.value);pW[pid]=isNaN(v)?null:r1(v);validate();});
  head.addEventListener('click',function(){toggleP(pid);updateFabState();});
}
function buildSubRow(s){
  var wrap=mkEl('div','');
  var fd=(FUNDS.sub_assets&&FUNDS.sub_assets[s.fk])?FUNDS.sub_assets[s.fk]:{recommended:[],all:[]};
  var recC=(fd.recommended&&fd.recommended.length)?fd.recommended.length:0;
  var allC=(fd.all&&fd.all.length)?fd.all.length:0;
  var hasFunds=(recC+allC)>0;
  var la=mkEl('div','s-list-area');
  var row=mkEl('div','s-list-row');
  var ll=mkEl('div','s-list-left');
  var lnm=mkEl('span','s-list-name');lnm.textContent=s.name;ll.appendChild(lnm);
  if(hasFunds){
    var eb=mkEl('button','s-expand-btn');eb.type='button';
    var ed=mkEl('span','s-expand-dot');ed.id='edot_'+s.id;
    ed.innerHTML='<svg viewBox="0 0 10 6"><polyline points="1,1 5,5 9,1" fill="none" stroke="#94A3B8" stroke-width="1.5"/></svg>';
    eb.appendChild(ed);
    eb.addEventListener('click',function(e){e.stopPropagation();toggleSInst(s.id);});
    ll.appendChild(eb);
  }
  var lr=mkEl('div','s-list-right');
  var sinp=mkNum('s-list-inp','0');sinp.id='sinp_'+s.id;
  var sp=mkEl('span','s-list-pct');sp.textContent='%';
  lr.appendChild(sinp);lr.appendChild(sp);
  row.appendChild(ll);row.appendChild(lr);
  la.appendChild(row);attachSubInp(s.id,sinp);wrap.appendChild(la);
  if(hasFunds){
    var ia=mkEl('div','s-inst-area');ia.id='iarea_'+s.id;
    var nr=Math.min(recC+allC,3);
    for(var i=0;i<nr;i++){
      var ir=mkEl('div','s-inst-row');
      var il=mkEl('span','s-inst-lbl');il.textContent='Fund '+(i+1);
      var sel=document.createElement('select');sel.className='s-inst-sel';sel.id='inst_'+s.id+'_'+i;
      var dop=document.createElement('option');dop.value='';dop.textContent=i===0?'\u2014 Select \u2014':'\u2014 Add another \u2014';sel.appendChild(dop);
      if(recC>0){var g1=document.createElement('optgroup');g1.label='\u2605 Recommended';for(var r=0;r<fd.recommended.length;r++){var o=document.createElement('option');o.value=fd.recommended[r];o.textContent=fd.recommended[r];g1.appendChild(o);}sel.appendChild(g1);}
      if(allC>0){var g2=document.createElement('optgroup');g2.label='All Funds';for(var r2=0;r2<fd.all.length;r2++){var o2=document.createElement('option');o2.value=fd.all[r2];o2.textContent=fd.all[r2];g2.appendChild(o2);}sel.appendChild(g2);}
      attachSel(s.id,sel);ir.appendChild(il);ir.appendChild(sel);ia.appendChild(ir);
    }
    var ft=mkEl('div','s-inst-foot');ft.textContent='Optional \u2014 up to '+nr+' instrument'+(nr>1?'s':'');
    ia.appendChild(ft);wrap.appendChild(ia);
  }
  return wrap;
}
function attachSubInp(sid,sinp){
  sinp.addEventListener('click',function(e){e.stopPropagation();});
  sinp.addEventListener('input',function(){var v=parseFloat(this.value);sW[sid]=isNaN(v)?null:r1(v);validate();});
}
function attachSel(sid,sel){
  sel.addEventListener('change',function(){
    var p=[];for(var i=0;i<3;i++){var e=document.getElementById('inst_'+sid+'_'+i);if(e&&e.value)p.push(e.value);}ins[sid]=p;
  });
}
function buildCustomRow(s){
  var wrap=mkEl('div','');
  var ca=mkEl('div','s-custom-area');
  var row=mkEl('div','s-custom-row');
  var icon=mkEl('div','s-custom-icon');icon.textContent='\u2736';
  var nm=mkEl('span','s-custom-name');nm.textContent=s.name;
  var sinp=mkNum('s-custom-inp','0');sinp.id='sinp_'+s.id;
  var pct=mkEl('span','s-custom-pct');pct.textContent='%';
  row.appendChild(icon);row.appendChild(nm);row.appendChild(sinp);row.appendChild(pct);
  ca.appendChild(row);attachSubInp(s.id,sinp);wrap.appendChild(ca);
  var na=mkEl('div','s-custom-note');
  var ni=document.createElement('input');ni.type='text';ni.placeholder='Notes / description\u2026';ni.id='ctxt_'+s.id;
  ni.addEventListener('input',function(){cTxt[s.id]=this.value;});
  na.appendChild(ni);wrap.appendChild(na);
  return wrap;
}
function toggleP(pid){
  pOpen[pid]=!pOpen[pid];
  var sec=document.getElementById('sec_'+pid),ch=document.getElementById('pchev_'+pid);
  if(sec)sec.className='s-section'+(pOpen[pid]?' open':'');
  if(ch)ch.className='p-chev'+(pOpen[pid]?' open':'');
}
function toggleSInst(sid){
  sOpen[sid]=!sOpen[sid];
  var a=document.getElementById('iarea_'+sid),d=document.getElementById('edot_'+sid);
  if(a)a.className='s-inst-area'+(sOpen[sid]?' open':'');
  if(d)d.className='s-expand-dot'+(sOpen[sid]?' open':'');
}
function updateFabState(){
  var any=false;
  for(var i=0;i<STRUCTURE.length;i++){if(pOpen[STRUCTURE[i].id]){any=true;break;}}
  allExpanded=any;
  var fab=document.getElementById('fab'),tip=document.getElementById('fab-tip');
  fab.textContent=allExpanded?'\u2212':'+';
  if(tip)tip.textContent=allExpanded?'Collapse all':'Expand all';
}
function fabToggleAll(){
  var open=!allExpanded;
  for(var i=0;i<STRUCTURE.length;i++){
    var pid=STRUCTURE[i].id;pOpen[pid]=open;
    var sec=document.getElementById('sec_'+pid),ch=document.getElementById('pchev_'+pid);
    if(sec)sec.className='s-section'+(open?' open':'');
    if(ch)ch.className='p-chev'+(open?' open':'');
  }
  allExpanded=open;updateFabState();
  if(open)window.scrollTo({top:0,behavior:'smooth'});
}
document.getElementById('fab').addEventListener('click',fabToggleAll);

/* ââ Reset ââ */
function openResetDialog(){var ro=document.getElementById('resetOverlay');ro.style.display='flex';requestAnimationFrame(function(){ro.classList.add('show');});}
function closeResetDialog(){var ro=document.getElementById('resetOverlay');ro.classList.remove('show');setTimeout(function(){ro.style.display='none';},180);}
function doReset(){
  document.getElementById('pname').value='';
  for(var i=0;i<STRUCTURE.length;i++){
    var p=STRUCTURE[i];pW[p.id]=null;
    var pinp=document.getElementById('pinp_'+p.id);if(pinp)pinp.value='';
    pOpen[p.id]=false;
    var sec=document.getElementById('sec_'+p.id),ch=document.getElementById('pchev_'+p.id);
    if(sec)sec.className='s-section';if(ch)ch.className='p-chev';
    for(var j=0;j<p.subs.length;j++){
      var s=p.subs[j];sW[s.id]=null;ins[s.id]=[];cTxt[s.id]='';
      var sinp=document.getElementById('sinp_'+s.id);if(sinp)sinp.value='';
      var ctxt=document.getElementById('ctxt_'+s.id);if(ctxt)ctxt.value='';
      for(var k=0;k<3;k++){var sel=document.getElementById('inst_'+s.id+'_'+k);if(sel)sel.selectedIndex=0;}
      sOpen[s.id]=false;
      var ia=document.getElementById('iarea_'+s.id),ed=document.getElementById('edot_'+s.id);
      if(ia)ia.className='s-inst-area';if(ed)ed.className='s-expand-dot';
    }
  }
  allExpanded=false;updateFabState();validate();closeResetDialog();
  showToast('\u2705 All weights cleared \u2014 ready to start fresh');
}
document.getElementById('btnReset').addEventListener('click',openResetDialog);
document.getElementById('rdCancel').addEventListener('click',closeResetDialog);
document.getElementById('rdConfirm').addEventListener('click',doReset);
document.getElementById('resetOverlay').addEventListener('click',function(e){if(e.target===this)closeResetDialog();});

/* ââ Validate ââ */
function validate(){
  var total=0,filled=0,i,w;
  for(i=0;i<STRUCTURE.length;i++){w=pW[STRUCTURE[i].id];if(w!==null&&!isNaN(w)){total+=w;filled++;}}
  var nP=STRUCTURE.length,allF=(filled===nP);
  var bar=document.getElementById('progBar'),pEl=document.getElementById('progPct'),st=document.getElementById('progStatus');
  var bb=document.getElementById('botBar'),bp=document.getElementById('botPct');
  var pct=Math.min(total,100);
  bar.style.width=pct+'%';bb.style.width=pct+'%';
  pEl.textContent=total.toFixed(1)+'%';bp.textContent=total.toFixed(1)+'%';
  var over=total>100.04;
  bar.style.background=over?'#EF4444':'#10B981';
  bb.className='bot-bar'+(over?' c-over':'');
  pEl.className=over?'c-over':'';
  bp.className='bot-alloc-pct'+(over?' c-over':'');
  if(over)st.textContent='\u26a0 Total exceeds 100% ('+total.toFixed(1)+'%)';
  else if(allF&&Math.abs(total-100)<0.05)st.textContent='\u2705 All parent classes filled \u2014 sums to 100%';
  else if(allF)st.textContent='Remaining: '+(100-total).toFixed(1)+'%';
  else st.textContent=filled+' of '+nP+' parent classes filled';
  for(i=0;i<STRUCTURE.length;i++){
    var p=STRUCTURE[i];w=pW[p.id];var te=document.getElementById('terr_'+p.id);
    if(w===null||isNaN(w)){if(te)te.className='p-tally-err';continue;}
    var subT=0,anyS=false;
    for(var j=0;j<p.subs.length;j++){var sw=sW[p.subs[j].id];if(sw!==null&&sw!==undefined&&!isNaN(sw)){subT+=sw;anyS=true;}}
    if(te)te.className='p-tally-err'+(anyS&&Math.abs(subT-w)>=0.06?' show':'');
  }
  var v=isValid();
  document.getElementById('btnSummary').className='btn-summary'+(v?'':' inactive');
  document.getElementById('btnExport').className='btn-pdf'+(v?'':' inactive');
}
function collectErrors(){
  var errs=[],total=0,missing=[],i,j,p,w,sw,subT,anyS;
  for(i=0;i<STRUCTURE.length;i++){w=pW[STRUCTURE[i].id];if(w===null||isNaN(w))missing.push(STRUCTURE[i].name);else total+=w;}
  if(missing.length)errs.push('Missing weight for:\n'+missing.join(', '));
  else if(Math.abs(total-100)>=0.05)errs.push('Weights sum to '+total.toFixed(1)+'% \u2014 must equal 100%');
  for(i=0;i<STRUCTURE.length;i++){
    p=STRUCTURE[i];w=pW[p.id];if(w===null||isNaN(w))continue;
    subT=0;anyS=false;
    for(j=0;j<p.subs.length;j++){sw=sW[p.subs[j].id];if(sw!==null&&!isNaN(sw)){subT+=sw;anyS=true;}}
    if(anyS&&Math.abs(subT-w)>=0.06)errs.push(p.name+': sub-weights ('+subT.toFixed(1)+'%) \u2260 parent ('+w.toFixed(1)+'%)');
  }
  return errs;
}
function isValid(){return collectErrors().length===0;}
function showToast(msg){
  var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  if(toastTimer)clearTimeout(toastTimer);
  toastTimer=setTimeout(function(){t.classList.remove('show');},4000);
}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

/* ââ Summary modal ââ */
function buildSummaryHTML(name,dateStr){
  var grand=0,html='',i,j,p,s,pw,sw,fs,sh,insts,ct,detail;
  html='<div class="m-meta">Portfolio: <b>'+esc(name)+'</b> &nbsp;&middot;&nbsp; '+dateStr+'</div>';
  for(i=0;i<STRUCTURE.length;i++){
    p=STRUCTURE[i];pw=pW[p.id]||0;grand+=pw;
    var a=ACCENT[i%ACCENT.length];
    fs=[];
    for(j=0;j<p.subs.length;j++){sw=sW[p.subs[j].id];if(sw!==null&&sw!==undefined&&!isNaN(sw))fs.push(p.subs[j]);}
    sh='';
    if(!fs.length){sh='<div class="m-empty">No sub-asset weights entered</div>';}
    else{
      for(j=0;j<fs.length;j++){
        s=fs[j];sw=sW[s.id];insts=ins[s.id]||[];ct=cTxt[s.id]||'';detail='';
        if(s.custom&&ct)detail='<div class="m-sinst">'+esc(ct)+'</div>';
        else if(!s.custom&&insts.length)detail='<div class="m-sinst">'+esc(insts.join(' \u00b7 '))+'</div>';
        sh+='<div class="m-srow"><div><div class="m-sname">'+esc(s.name)+'</div>'+detail+'</div><div class="m-swt">'+sw.toFixed(1)+'%</div></div>';
      }
    }
    html+='<div class="m-pblock"><div class="m-phdr" style="background:'+a.bar+'"><span>'+esc(p.name)+'</span><span>'+pw.toFixed(1)+'%</span></div><div class="m-subs">'+sh+'</div></div>';
  }
  html+='<div class="m-total"><span>Total Allocation</span><span>'+grand.toFixed(1)+'%</span></div>';
  return html;
}
function openSummary(){
  var errs=collectErrors();if(errs.length){showToast(errs.join('\n'));return;}
  var name=document.getElementById('pname').value||'Unnamed Portfolio';
  var dateStr=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
  document.getElementById('modalBody').innerHTML=buildSummaryHTML(name,dateStr);
  document.getElementById('overlay').style.display='flex';
  requestAnimationFrame(function(){document.getElementById('overlay').classList.add('show');});
}
function closeSummary(){
  document.getElementById('overlay').classList.remove('show');
  setTimeout(function(){document.getElementById('overlay').style.display='none';},220);
}
document.getElementById('btnSummary').addEventListener('click',openSummary);
document.getElementById('btnClose').addEventListener('click',closeSummary);
document.getElementById('overlay').addEventListener('click',function(e){if(e.target===this)closeSummary();});

/* ââââââââââââââââââââââââââââââââââââââââââââââââââââ
   PDF GENERATION  â  jsPDF + no external rasteriser
   Draws everything natively on a jsPDF canvas:
     â¢ branded header bar
     â¢ donut chart (drawn with jsPDF arc calls)
     â¢ allocation table with coloured row headers
   ââââââââââââââââââââââââââââââââââââââââââââââââââââ */
var _jsPDFLoaded=false;
function loadJsPDF(cb){
  if(window.jspdf&&window.jspdf.jsPDF){cb();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
  s.onload=function(){_jsPDFLoaded=true;cb();};
  s.onerror=function(){showToast('\u26a0 Could not load PDF library. Check internet connection.');};
  document.head.appendChild(s);
}

function drawDonut(doc,cx,cy,R,r,slices){
  /* slices: [{pct, color}] */
  var total=0;for(var i=0;i<slices.length;i++)total+=slices[i].pct;
  if(total<=0)return;
  var angle=-Math.PI/2; /* start at top */
  for(var i=0;i<slices.length;i++){
    var sweep=(slices[i].pct/100)*2*Math.PI;
    if(sweep<0.001)continue;
    var a1=angle,a2=angle+sweep;
    /* Build wedge path manually */
    var pts=[];
    var steps=Math.max(2,Math.round(sweep/(Math.PI/18)));
    /* outer arc */
    for(var k=0;k<=steps;k++){var a=a1+(a2-a1)*(k/steps);pts.push([cx+R*Math.cos(a),cy+R*Math.sin(a)]);}
    /* inner arc reversed */
    for(var k=steps;k>=0;k--){var a=a1+(a2-a1)*(k/steps);pts.push([cx+r*Math.cos(a),cy+r*Math.sin(a)]);}
    doc.setFillColor(slices[i].color);
    doc.moveTo(pts[0][0],pts[0][1]);
    /* use lines â jsPDF 2.x supports lines() */
    var lps=[];for(var m=1;m<pts.length;m++)lps.push([pts[m][0]-pts[m-1][0],pts[m][1]-pts[m-1][1]]);
    doc.lines(lps,pts[0][0],pts[0][1],[1,1],null,true); /* null=no stroke, true=closed */
    doc.fill();
    angle=a2;
  }
  /* Centre hole: white circle */
  doc.setFillColor('#FFFFFF');
  doc.circle(cx,cy,r-0.5,'F');
}

function generatePDF(){
  var errs=collectErrors();if(errs.length){showToast(errs.join('\n'));return;}
  var btn=document.getElementById('btnExport');
  btn.textContent='\u23F3 Building\u2026';btn.classList.add('loading');btn.disabled=true;

  loadJsPDF(function(){
    try{
      var jsPDF=window.jspdf.jsPDF;
      var doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
      var pw=210,ph=297; /* A4 */
      var lm=14,rm=14,tm=0,cw=pw-lm-rm; /* margins */

      var name=document.getElementById('pname').value||'Unnamed Portfolio';
      var dateStr=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});

      /* ââ Collect data ââ */
      var rows=[];
      for(var i=0;i<STRUCTURE.length;i++){
        var p=STRUCTURE[i],pw_=pW[p.id]||0;
        if(pw_<=0)continue;
        var subs=[];
        for(var j=0;j<p.subs.length;j++){
          var s=p.subs[j],sw=sW[s.id];
          if(sw===null||sw===undefined||isNaN(sw)||sw<=0)continue;
          var insts=ins[s.id]||[],ct=cTxt[s.id]||'';
          subs.push({name:s.name,pct:sw,label:s.custom?(ct||'â'):(insts.length?insts[0]:'')});
        }
        rows.push({name:p.name,pct:pw_,color:ACCENT[i%ACCENT.length].bar,subs:subs});
      }

      /* ââ 1. Header bar ââ */
      doc.setFillColor('#0F172A');
      doc.rect(0,0,210,22,'F');
      doc.setTextColor('#FFFFFF');
      doc.setFont('helvetica','bold');
      doc.setFontSize(13);
      doc.text('Portfolio Constructor',lm,9);
      doc.setFont('helvetica','normal');
      doc.setFontSize(8);
      doc.text('Asset Allocation Report',lm,14.5);
      doc.setFont('helvetica','bold');
      doc.setFontSize(9);
      doc.text(name,lm,20);
      /* date right-aligned */
      doc.setFont('helvetica','normal');
      doc.setFontSize(8);
      doc.setTextColor('#94A3B8');
      var dw=doc.getTextWidth(dateStr);
      doc.text(dateStr,pw-rm-dw,20);

      var y=30; /* cursor */

      /* ââ 2. Donut chart ââ */
      var cx=lm+30,cy=y+28,R=26,r=14;
      /* build slices */
      var slices=[];for(var i=0;i<rows.length;i++)slices.push({pct:rows[i].pct,color:rows[i].color});
      drawDonut(doc,cx,cy,R,r,slices);
      /* centre label */
      doc.setTextColor('#0F172A');
      doc.setFont('helvetica','bold');
      doc.setFontSize(9);
      var lbl='100%';var lw=doc.getTextWidth(lbl);
      doc.text(lbl,cx-lw/2,cy+1.5);
      doc.setFont('helvetica','normal');
      doc.setFontSize(6);
      doc.setTextColor('#64748B');
      var al='allocated';var aw=doc.getTextWidth(al);
      doc.text(al,cx-aw/2,cy+5.5);

      /* Legend to the right of donut */
      var lx=cx+R+8,ly=y+4;
      for(var i=0;i<rows.length;i++){
        doc.setFillColor(rows[i].color);
        doc.roundedRect(lx,ly+i*7,3,3,0.5,0.5,'F');
        doc.setTextColor('#0F172A');
        doc.setFont('helvetica','bold');
        doc.setFontSize(7.5);
        doc.text(rows[i].name,lx+5,ly+i*7+2.4);
        doc.setFont('helvetica','normal');
        doc.setTextColor('#64748B');
        var pw2=doc.getTextWidth(rows[i].pct.toFixed(1)+'%');
        doc.text(rows[i].pct.toFixed(1)+'%',lm+cw-pw2,ly+i*7+2.4);
      }

      y=cy+R+10; /* below chart */

      /* ââ 3. Divider ââ */
      doc.setDrawColor('#E2E8F0');
      doc.setLineWidth(0.3);
      doc.line(lm,y,lm+cw,y);
      y+=6;

      /* ââ 4. Allocation table ââ */
      doc.setFont('helvetica','bold');
      doc.setFontSize(9);
      doc.setTextColor('#0F172A');
      doc.text('Detailed Allocation',lm,y);
      y+=5;

      for(var i=0;i<rows.length;i++){
        var row=rows[i];
        /* Parent row â coloured background */
        doc.setFillColor(row.color);
        doc.rect(lm,y,cw,7,'F');
        doc.setTextColor('#FFFFFF');
        doc.setFont('helvetica','bold');
        doc.setFontSize(8.5);
        doc.text(row.name,lm+3,y+4.8);
        var pp=row.pct.toFixed(1)+'%';
        var ppw=doc.getTextWidth(pp);
        doc.text(pp,lm+cw-ppw-3,y+4.8);
        y+=7;

        /* Sub rows */
        for(var j=0;j<row.subs.length;j++){
          var sub=row.subs[j];
          var bg=j%2===0?'#F8FAFC':'#FFFFFF';
          doc.setFillColor(bg);
          doc.rect(lm,y,cw,6.5,'F');
          doc.setTextColor('#1E293B');
          doc.setFont('helvetica','bold');
          doc.setFontSize(7.5);
          doc.text(sub.name,lm+6,y+4.3);
          if(sub.label){
            doc.setFont('helvetica','normal');
            doc.setTextColor('#64748B');
            doc.setFontSize(6.5);
            doc.text(sub.label,lm+6,y+4.3+4);
            y+=4; /* extra height for instrument line */
          }
          var sp=sub.pct.toFixed(1)+'%';
          var spw=doc.getTextWidth(sp);
          doc.setFont('helvetica','bold');
          doc.setFontSize(7.5);
          doc.setTextColor('#0F172A');
          doc.text(sp,lm+cw-spw-3,y+4.3);
          y+=6.5;
        }
        if(!row.subs.length){
          doc.setFillColor('#F8FAFC');
          doc.rect(lm,y,cw,6,'F');
          doc.setFont('helvetica','normal');
          doc.setFontSize(7);
          doc.setTextColor('#94A3B8');
          doc.text('No sub-asset breakdown entered',lm+6,y+4);
          y+=6;
        }
        y+=2; /* gap between parent blocks */

        /* Page break safety */
        if(y>ph-20){doc.addPage();y=14;}
      }

      /* ââ 5. Total row ââ */
      y+=2;
      doc.setFillColor('#ECFDF5');
      doc.rect(lm,y,cw,8,'F');
      doc.setDrawColor('#6EE7B7');
      doc.setLineWidth(0.4);
      doc.rect(lm,y,cw,8,'S');
      doc.setFont('helvetica','bold');
      doc.setFontSize(9);
      doc.setTextColor('#065F46');
      doc.text('Total Allocation',lm+4,y+5.5);
      var tot='100.0%';var tw=doc.getTextWidth(tot);
      doc.text(tot,lm+cw-tw-4,y+5.5);

      /* ââ 6. Footer ââ */
      doc.setFont('helvetica','normal');
      doc.setFontSize(6.5);
      doc.setTextColor('#94A3B8');
      var foot='Generated by Portfolio Constructor \u00b7 '+dateStr+' \u00b7 For informational purposes only';
      var fw=doc.getTextWidth(foot);
      doc.text(foot,(pw-fw)/2,ph-6);

      /* ââ Save ââ */
      var fname=(name.replace(/[^a-z0-9]/gi,'_')||'portfolio')+'_allocation.pdf';
      doc.save(fname);
      showToast('\u2705 PDF saved as '+fname);
    }catch(err){
      showToast('\u26a0 PDF error: '+err.message);
      console.error(err);
    }
    btn.innerHTML='&#x2B07; PDF';btn.classList.remove('loading');btn.disabled=false;
  });
}

document.getElementById('btnExport').addEventListener('click',generatePDF);

buildUI();validate();updateFabState();
</script>
</body></html>